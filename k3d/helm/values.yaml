# Environment configuration
# 'local' = Skaffold local development (no registry prefix)
# 'production' = ArgoCD with k3d built-in registry
environment: local

# Registry configuration (only used when environment: production)
registry:
  url: master-registry:5000
  # ImagePullSecret not needed for k3d insecure registry
  imagePullSecret: ""

# Image configurations
# Note: Skaffold overrides these with local builds during 'skaffold dev'
# ArgoCD Image Updater updates these tags when new images are pushed to registry
fastapi:
  image: coelho-realtime-fastapi:latest
  imagePullPolicy: IfNotPresent
  replicas: 0  # Disabled for Reflex-only development
  resources:
    requests:
      memory: "512Mi"
      cpu: "300m"
    limits:
      memory: "1536Mi"
      cpu: "750m"
  portsSettings:
    ports:
      - name: http
        port: 8000
        targetPort: 8000
        nodePort: 30000
        protocol: TCP
    type: LoadBalancer #ClusterIP
  livenessProbeSettings:
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 60  # Wait 1 minute for startup
      periodSeconds: 30      # Check every 30 seconds
      failureThreshold: 3    # Restart after 3 failures (90 seconds of unresponsiveness)


kafka:
  image: coelho-realtime-kafka:latest
  imagePullPolicy: IfNotPresent
  replicas: 0  # Disabled for Reflex-only development
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  portsSettings:
    ports:
      - name: external
        port: 9092
        targetPort: 9092
        nodePort: 30001
        protocol: TCP
      - name: internal
        port: 29092
        targetPort: 29092
        protocol: TCP
      - name: controller
        port: 9093
        targetPort: 9093
        protocol: TCP
    type: LoadBalancer #ClusterIP
  storageSize: 2Gi
  storageClassName: local-path
  livenessProbeSettings:
    livenessProbe:
      tcpSocket:
        port: 29092
      initialDelaySeconds: 90
      periodSeconds: 30
      failureThreshold: 5
  readinessProbeSettings:
    readinessProbe:
      tcpSocket:
        port: 29092
      initialDelaySeconds: 60
      periodSeconds: 10
      failureThreshold: 6


streamlit:
  image: coelho-realtime-streamlit:latest
  imagePullPolicy: IfNotPresent
  replicas: 0  # Disabled for Reflex-only development
  resources:
    requests:
      memory: "256Mi"
      cpu: "125m"
    limits:
      memory: "512Mi"
      cpu: "250m"
  portsSettings:
    ports:
      - name: http
        port: 8501
        targetPort: 8501
        nodePort: 30003
        protocol: TCP
    type: LoadBalancer #ClusterIP
  livenessProbeSettings:
    livenessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 30
      periodSeconds: 15
      failureThreshold: 3
  readinessProbeSettings:
    readinessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 10
      periodSeconds: 10
      failureThreshold: 3

# MLflow subchart configuration
mlflow:
  enabled: false  # Disabled for Reflex-only development
  service:
    type: ClusterIP
    port: 5000
    containerPort: 5000
  backendStore:
    defaultSqlitePath: ":memory:"
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"


reflex:
  image: coelho-realtime-reflex:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  portsSettings:
    ports:
      - name: frontend
        port: 3000
        targetPort: 3000
        nodePort: 30004
        protocol: TCP
      - name: backend
        port: 8000
        targetPort: 8000
        nodePort: 30005
        protocol: TCP
    type: LoadBalancer
  livenessProbeSettings:
    livenessProbe:
      tcpSocket:
        port: 3000
      initialDelaySeconds: 120
      periodSeconds: 20
      failureThreshold: 5
  readinessProbeSettings:
    readinessProbe:
      tcpSocket:
        port: 3000
      initialDelaySeconds: 90
      periodSeconds: 10
      failureThreshold: 6

# Redis configuration (Bitnami Redis chart)
# Used by Reflex for state management in production
redis:
  enabled: true
  architecture: standalone  # Use 'replication' for high availability
  auth:
    enabled: false  # Disable authentication for simplicity in local k3d
  master:
    persistence:
      enabled: true
      size: 2Gi
      storageClass: local-path
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "250m"
  # Redis configuration for Reflex optimization
  commonConfiguration: |-
    # Enable AOF persistence for better durability
    appendonly yes
    # Disable RDB snapshots (we use AOF)
    save ""
    # Set max memory and eviction policy
    maxmemory 256mb
    maxmemory-policy allkeys-lru
