# Environment configuration
# 'local' = Skaffold local development (no registry prefix)
# 'production' = ArgoCD with k3d built-in registry
environment: local

# Registry configuration (only used when environment: production)
registry:
  url: master-registry:5000
  # ImagePullSecret not needed for k3d insecure registry
  imagePullSecret: ""

# Image configurations
# Note: Skaffold overrides these with local builds during 'skaffold dev'
# ArgoCD Image Updater updates these tags when new images are pushed to registry
fastapi:
  image: coelho-realtime-fastapi:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "8Gi"
      cpu: "2000m"
    limits:
      memory: "16Gi"
      cpu: "4000m"
  portsSettings:
    ports:
      - name: http
        port: 8001
        targetPort: 8001
        nodePort: 30000
        protocol: TCP
    type: LoadBalancer #ClusterIP
  livenessProbeSettings:
    livenessProbe:
      httpGet:
        path: /health
        port: 8001
      initialDelaySeconds: 120  # Wait 2 minutes for startup (model loading)
      periodSeconds: 30         # Check every 30 seconds
      timeoutSeconds: 10        # Allow 10 seconds for response (was 1s default!)
      failureThreshold: 5       # Restart after 5 failures (150 seconds of unresponsiveness)
  readinessProbeSettings:
    readinessProbe:
      httpGet:
        path: /health
        port: 8001
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3


kafka:
  image: coelho-realtime-kafka:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  portsSettings:
    ports:
      - name: external
        port: 9092
        targetPort: 9092
        nodePort: 30001
        protocol: TCP
      - name: internal
        port: 29092
        targetPort: 29092
        protocol: TCP
      - name: controller
        port: 9093
        targetPort: 9093
        protocol: TCP
    type: LoadBalancer #ClusterIP
  storageSize: 2Gi
  storageClassName: local-path
  livenessProbeSettings:
    livenessProbe:
      tcpSocket:
        port: 29092
      initialDelaySeconds: 90
      periodSeconds: 30
      failureThreshold: 5
  readinessProbeSettings:
    readinessProbe:
      tcpSocket:
        port: 29092
      initialDelaySeconds: 60
      periodSeconds: 10
      failureThreshold: 6


# DEPRECATED: Streamlit has been replaced by Reflex
# Set enabled: true to re-enable if needed for reference
streamlit:
  enabled: false
  image: coelho-realtime-streamlit:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "256Mi"
      cpu: "125m"
    limits:
      memory: "512Mi"
      cpu: "250m"
  portsSettings:
    ports:
      - name: http
        port: 8501
        targetPort: 8501
        nodePort: 30003
        protocol: TCP
    type: LoadBalancer #ClusterIP
  livenessProbeSettings:
    livenessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 30
      periodSeconds: 15
      failureThreshold: 3
  readinessProbeSettings:
    readinessProbe:
      httpGet:
        path: /_stcore/health
        port: 8501
      initialDelaySeconds: 10
      periodSeconds: 10
      failureThreshold: 3


# MLflow subchart configuration (community-charts/mlflow)
# Connects to MinIO for artifacts, SQLite for metadata
mlflow:
  # Service configuration
  service:
    type: ClusterIP
    port: 5000
    containerPort: 5000
  # Gunicorn: single worker to avoid SQLite lock contention (recommended for dev)
  extraArgs:
    workers: "1"
  # Backend store using SQLite (persisted via hostPath PVC)
  backendStore:
    databaseMigration: true
    defaultSqlitePath: "/mlflow-data/mlflow.db"
  # Artifact store pointing to MinIO S3-compatible storage
  artifactRoot:
    s3:
      enabled: true
      bucket: "mlflow-artifacts"
      awsAccessKeyId: "minioadmin"
      awsSecretAccessKey: "minioadmin123"
  # Resource limits
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  # Environment variables for MinIO/S3 connection
  extraEnvVars:
    # Allow external connections (required for Python MLflow client)
    MLFLOW_SERVER_ALLOWED_HOSTS: "*"
    # MinIO S3 endpoint (internal cluster service)
    MLFLOW_S3_ENDPOINT_URL: "http://coelho-realtime-minio:9000"
    MLFLOW_S3_IGNORE_TLS: "true"
    AWS_DEFAULT_REGION: "us-east-1"
  # Persistent storage for SQLite metadata database
  extraVolumes:
    - name: mlflow-data
      persistentVolumeClaim:
        claimName: coelho-realtime-mlflow-pvc
  extraVolumeMounts:
    - name: mlflow-data
      mountPath: /mlflow-data


reflex:
  image: coelho-realtime-reflex:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
  portsSettings:
    ports:
      - name: frontend
        port: 3000
        targetPort: 3000
        nodePort: 30004
        protocol: TCP
      - name: backend
        port: 8000
        targetPort: 8000
        nodePort: 30005
        protocol: TCP
    type: LoadBalancer
  livenessProbeSettings:
    livenessProbe:
      tcpSocket:
        port: 3000
      initialDelaySeconds: 120
      periodSeconds: 20
      failureThreshold: 5
  readinessProbeSettings:
    readinessProbe:
      tcpSocket:
        port: 3000
      initialDelaySeconds: 90
      periodSeconds: 10
      failureThreshold: 6


# River ML Training Service
# Handles incremental ML model training using River library
river:
  image: coelho-realtime-river:latest
  imagePullPolicy: IfNotPresent
  replicas: 1
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"
  portsSettings:
    ports:
      - name: http
        port: 8002
        targetPort: 8002
        nodePort: 30006
        protocol: TCP
    type: LoadBalancer
  livenessProbeSettings:
    livenessProbe:
      httpGet:
        path: /health
        port: 8002
      initialDelaySeconds: 60
      periodSeconds: 30
      failureThreshold: 5
  readinessProbeSettings:
    readinessProbe:
      httpGet:
        path: /health
        port: 8002
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3


# Redis configuration (Bitnami Redis chart)
# Used by Reflex for state management in production
redis:
  enabled: true
  architecture: standalone  # Use 'replication' for high availability
  auth:
    enabled: false  # Disable authentication for simplicity in local k3d
  master:
    persistence:
      enabled: true
      size: 2Gi
      storageClass: local-path
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "250m"
  # Redis configuration for Reflex optimization
  commonConfiguration: |-
    # Enable AOF persistence for better durability
    appendonly yes
    # Disable RDB snapshots (we use AOF)
    save ""
    # Set max memory and eviction policy
    maxmemory 256mb
    maxmemory-policy allkeys-lru


# MinIO Object Storage (S3-compatible) - Official MinIO Chart (https://helm.min.io/)
# Used for storing parquet files and MLflow artifacts
# Data persists in /data/minio on host via K3d volume mount
minio:
  enabled: true
  # Deployment mode
  mode: standalone
  # Root credentials
  rootUser: "minioadmin"
  rootPassword: "minioadmin123"
  # MinIO API Service (S3 endpoint)
  service:
    type: NodePort
    port: "9000"
    nodePort: 30900
  # MinIO Console Service (Web UI)
  consoleService:
    type: NodePort
    port: "9001"
    nodePort: 30901
  # Persistence using pre-created PVC with hostPath (survives skaffold dev Ctrl+C)
  persistence:
    enabled: true
    existingClaim: "minio-hostpath-pvc"
  # Security context - run as root to avoid permission issues with hostPath
  securityContext:
    enabled: false
  containerSecurityContext:
    enabled: false
  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi
  # Replicas (standalone mode = 1)
  replicas: 1
  # Default buckets to create on startup
  buckets:
    - name: mlflow-artifacts
      policy: none
      purge: false
  # Service account
  serviceAccount:
    create: true
    name: "minio-sa"
  # Disable ingress for local development
  ingress:
    enabled: false
  consoleIngress:
    enabled: false
