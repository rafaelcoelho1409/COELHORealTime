stages:
  - build

variables:
  # Use k3d built-in registry (already configured and trusted by all nodes)
  REGISTRY: master-registry:5000

# Build and push Docker images to Docker Registry
build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      command: ["--tls=false", "--insecure-registry=master-registry:5000"]
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    GIT_STRATEGY: none
  before_script:
    # Manual git clone (required because GitLab external_url is localhost, not the k8s service URL)
    - apk add --no-cache git
    - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab-webservice-default.gitlab.svc.cluster.local:8181/public-projects/COELHORealTime.git ${CI_PROJECT_DIR}
    - cd ${CI_PROJECT_DIR}
    - git checkout ${CI_COMMIT_SHA}
    # Wait for Docker daemon to be ready
    - until docker info >/dev/null 2>&1; do echo "Waiting for Docker daemon..."; sleep 1; done
    # Test connectivity to Docker Registry
    - echo "Testing connectivity to Docker Registry..."
    - wget -q --spider http://${REGISTRY}/v2/ && echo "✓ Registry is accessible" || echo "⚠ Registry check completed"
  script:
    # Build and push FastAPI
    - echo "Building FastAPI image..."
    - docker build -t ${REGISTRY}/coelho-realtime-fastapi:${CI_COMMIT_SHA} -t ${REGISTRY}/coelho-realtime-fastapi:latest ./apps/fastapi -f ./apps/fastapi/Dockerfile.fastapi
    - docker push ${REGISTRY}/coelho-realtime-fastapi:${CI_COMMIT_SHA}
    - docker push ${REGISTRY}/coelho-realtime-fastapi:latest
    # Build and push Kafka
    - echo "Building Kafka image..."
    - docker build -t ${REGISTRY}/coelho-realtime-kafka:${CI_COMMIT_SHA} -t ${REGISTRY}/coelho-realtime-kafka:latest ./apps/kafka -f ./apps/kafka/Dockerfile.kafka
    - docker push ${REGISTRY}/coelho-realtime-kafka:${CI_COMMIT_SHA}
    - docker push ${REGISTRY}/coelho-realtime-kafka:latest
    # Build and push MLflow
    - echo "Building MLflow image..."
    - docker build -t ${REGISTRY}/coelho-realtime-mlflow:${CI_COMMIT_SHA} -t ${REGISTRY}/coelho-realtime-mlflow:latest ./apps/mlflow -f ./apps/mlflow/Dockerfile.mlflow
    - docker push ${REGISTRY}/coelho-realtime-mlflow:${CI_COMMIT_SHA}
    - docker push ${REGISTRY}/coelho-realtime-mlflow:latest
    # Build and push Streamlit
    - echo "Building Streamlit image..."
    - docker build -t ${REGISTRY}/coelho-realtime-streamlit:${CI_COMMIT_SHA} -t ${REGISTRY}/coelho-realtime-streamlit:latest ./apps/streamlit -f ./apps/streamlit/Dockerfile.streamlit
    - docker push ${REGISTRY}/coelho-realtime-streamlit:${CI_COMMIT_SHA}
    - docker push ${REGISTRY}/coelho-realtime-streamlit:latest
  only:
    - master

# Note: Image tag updates are now handled automatically by ArgoCD Image Updater
# When new images are pushed to Docker Registry, Image Updater will:
#   1. Detect new :latest tags in the registry
#   2. Update k3d/helm/values.yaml with new image tags
#   3. Commit changes back to Git
#   4. ArgoCD auto-syncs and deploys new images
